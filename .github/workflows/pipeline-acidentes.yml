name: Pipeline Acidentes BR-116

on:
  schedule:
    - cron: "0 3 * * 1"        # Base limpa — segunda 03:00
    - cron: "40 3 * * *"       # Base viva — diário 03:40
    - cron: "20 5 * * 1,5"     # Monitoramento — segunda e sexta 05:20
  workflow_dispatch:           # Execução manual
  push:
    branches:
      - main                   # Push na main roda base viva

concurrency:
  group: pipeline-acidentes
  cancel-in-progress: false

jobs:

  # ============================================================
  # BASE LIMPA — semanal e manual
  # ============================================================
  base_limpa:
    runs-on: ubuntu-latest

    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'schedule' && startsWith(github.event.schedule, '0 3 * * 1'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev

      - name: Install R packages
        run: |
          Rscript -e "install.packages(c('dotenv','httr','jsonlite','dplyr'), repos='https://cloud.r-project.org')"

      - name: Run script base limpa
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: Rscript scripts/01-Upload-Auto-CSV-Supabase.R


  # ============================================================
  # BASE VIVA — push, diário e manual
  # ============================================================
  base_viva:
    runs-on: ubuntu-latest
    needs: base_limpa

    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event_name == 'schedule' && startsWith(github.event.schedule, '10 3 * * *'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev

      - name: Install R packages
        run: |
          Rscript -e "install.packages(c('dotenv','httr','jsonlite','dplyr','lubridate'), repos='https://cloud.r-project.org')"

      - name: Run script base viva
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: Rscript scripts/02-Upload-Auto-Supabase-Base-Viva.R


  # ============================================================
  # MONITORAMENTO — segunda e sexta às 05:10
  # ============================================================
  monitoramento:
    runs-on: ubuntu-latest
    needs: base_viva

    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'schedule' && startsWith(github.event.schedule, '10 5 * *'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev

      - name: Install R packages
        run: |
          Rscript -e "install.packages(c('dotenv','httr','jsonlite','dplyr','lubridate','pROC'), repos='https://cloud.r-project.org')"
          Rscript -e "install.packages('InformationValue', repos='https://cloud.r-project.org', dependencies=TRUE)"

      - name: Run script monitoramento
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: Rscript scripts/03-Monitoramento-Modelo-Preditivo.R