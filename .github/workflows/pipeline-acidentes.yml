name: Pipeline Acidentes BR-116

on:
  schedule:
    - cron: "0 3 * * 1"   # Base limpa: segunda 03:00
    - cron: "10 3 * * *"  # Base viva: diária 03:10
  workflow_dispatch:       # Manual
  push:
    branches:
      - main               # Push só dispara base viva

concurrency:
  group: pipeline-acidentes
  cancel-in-progress: false

jobs:

  base_limpa:
    runs-on: ubuntu-latest

    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'schedule' && startsWith(github.event.schedule, '0 3 * * 1'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev

      - name: Install R packages
        run: |
          Rscript -e "install.packages(c('dotenv','httr','jsonlite','dplyr'), repos='https://cloud.r-project.org')"

      - name: Run script base limpa
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: Rscript scripts/01-Upload-Auto-CSV-Supabase.R

  base_viva:
    runs-on: ubuntu-latest
    needs: base_limpa

    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event_name == 'schedule' && startsWith(github.event.schedule, '10 3 * * *'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev

      - name: Install R packages
        run: |
          Rscript -e "install.packages(c('dotenv','httr','jsonlite','dplyr','lubridate'), repos='https://cloud.r-project.org')"

      - name: Run script base viva
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: Rscript scripts/02-Upload-Auto-Supabase-Base-Viva.R
